# Skill: CVE Research

Investigación de CVEs usando múltiples fuentes OSINT.

---

## NVD API v2.0

```python
import httpx
from dataclasses import dataclass


@dataclass
class NVDData:
    cve_id: str
    description: str
    cvss_v3_score: float | None
    cvss_v3_vector: str | None
    references: list[str]
    cwe_ids: list[str]
    published: str
    modified: str


async def fetch_nvd(cve_id: str, api_key: str | None = None) -> NVDData | None:
    """Fetch CVE data from NVD API v2.0."""

    url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    headers = {}
    if api_key:
        headers["apiKey"] = api_key

    async with httpx.AsyncClient(
        timeout=httpx.Timeout(connect=5.0, read=30.0)
    ) as client:
        response = await client.get(url, params={"cveId": cve_id}, headers=headers)
        response.raise_for_status()
        data = response.json()

    vulns = data.get("vulnerabilities", [])
    if not vulns:
        return None

    cve = vulns[0]["cve"]

    # Extract CVSS v3.1
    metrics = cve.get("metrics", {})
    cvss_v31 = metrics.get("cvssMetricV31", [{}])[0].get("cvssData", {})

    # Extract descriptions (English)
    descriptions = cve.get("descriptions", [])
    description = next(
        (d["value"] for d in descriptions if d["lang"] == "en"),
        ""
    )

    # Extract references
    references = [ref["url"] for ref in cve.get("references", [])]

    # Extract CWE
    weaknesses = cve.get("weaknesses", [])
    cwe_ids = []
    for weakness in weaknesses:
        for desc in weakness.get("description", []):
            if desc.get("value", "").startswith("CWE-"):
                cwe_ids.append(desc["value"])

    return NVDData(
        cve_id=cve_id,
        description=description,
        cvss_v3_score=cvss_v31.get("baseScore"),
        cvss_v3_vector=cvss_v31.get("vectorString"),
        references=references,
        cwe_ids=cwe_ids,
        published=cve.get("published", ""),
        modified=cve.get("lastModified", ""),
    )
```

---

## GitHub Security Advisories (GraphQL)

```python
@dataclass
class GitHubAdvisory:
    ghsa_id: str
    summary: str
    severity: str
    published_at: str
    vulnerabilities: list[dict]


async def fetch_github_advisory(
    cve_id: str,
    token: str,
) -> GitHubAdvisory | None:
    """Fetch advisory from GitHub GraphQL API."""

    query = """
    query($cve: String!) {
      securityAdvisories(first: 1, identifier: {type: CVE, value: $cve}) {
        nodes {
          ghsaId
          summary
          severity
          publishedAt
          vulnerabilities(first: 10) {
            nodes {
              package { ecosystem name }
              vulnerableVersionRange
              firstPatchedVersion { identifier }
            }
          }
        }
      }
    }
    """

    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://api.github.com/graphql",
            headers={"Authorization": f"Bearer {token}"},
            json={"query": query, "variables": {"cve": cve_id}},
        )
        response.raise_for_status()
        data = response.json()

    nodes = data.get("data", {}).get("securityAdvisories", {}).get("nodes", [])
    if not nodes:
        return None

    advisory = nodes[0]
    return GitHubAdvisory(
        ghsa_id=advisory["ghsaId"],
        summary=advisory["summary"],
        severity=advisory["severity"],
        published_at=advisory["publishedAt"],
        vulnerabilities=[
            {
                "ecosystem": v["package"]["ecosystem"],
                "package": v["package"]["name"],
                "vulnerable_range": v["vulnerableVersionRange"],
                "patched_version": v.get("firstPatchedVersion", {}).get("identifier"),
            }
            for v in advisory.get("vulnerabilities", {}).get("nodes", [])
        ],
    )
```

---

## EPSS Score

```python
@dataclass
class EPSSData:
    cve_id: str
    epss: float  # Probability 0-1
    percentile: float  # Ranking 0-1
    date: str


async def fetch_epss(cve_id: str) -> EPSSData | None:
    """Fetch EPSS score from FIRST API."""

    url = "https://api.first.org/data/v1/epss"

    async with httpx.AsyncClient() as client:
        response = await client.get(url, params={"cve": cve_id})
        response.raise_for_status()
        data = response.json()

    scores = data.get("data", [])
    if not scores:
        return None

    score = scores[0]
    return EPSSData(
        cve_id=score["cve"],
        epss=float(score["epss"]),
        percentile=float(score["percentile"]),
        date=score.get("date", ""),
    )
```

---

## CISA KEV (Known Exploited Vulnerabilities)

```python
async def check_cisa_kev(cve_id: str) -> bool:
    """Check if CVE is in CISA Known Exploited Vulnerabilities catalog."""

    url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"

    async with httpx.AsyncClient() as client:
        response = await client.get(url)
        response.raise_for_status()
        data = response.json()

    kev_cves = {v["cveID"] for v in data.get("vulnerabilities", [])}
    return cve_id in kev_cves
```

---

## Tavily Search (OSINT)

```python
@dataclass
class OSINTResult:
    title: str
    url: str
    content: str
    score: float


async def search_osint(
    cve_id: str,
    api_key: str,
) -> list[OSINTResult]:
    """Search for exploits and POCs via Tavily."""

    url = "https://api.tavily.com/search"

    async with httpx.AsyncClient() as client:
        response = await client.post(
            url,
            json={
                "api_key": api_key,
                "query": f"{cve_id} exploit POC proof of concept",
                "search_depth": "advanced",
                "include_domains": [
                    "github.com",
                    "exploit-db.com",
                    "packetstormsecurity.com",
                ],
                "max_results": 10,
            },
        )
        response.raise_for_status()
        data = response.json()

    return [
        OSINTResult(
            title=r["title"],
            url=r["url"],
            content=r["content"][:500],
            score=r["score"],
        )
        for r in data.get("results", [])
    ]
```

---

## Aggregate Research

```python
@dataclass
class CVEResearchResult:
    cve_id: str
    nvd: NVDData | None
    github: GitHubAdvisory | None
    epss: EPSSData | None
    in_kev: bool
    osint: list[OSINTResult]
    risk_assessment: str


async def research_cve(cve_id: str, config: Config) -> CVEResearchResult:
    """Aggregate CVE research from all sources."""

    # Fetch all in parallel
    nvd, github, epss, in_kev, osint = await asyncio.gather(
        fetch_nvd(cve_id, config.nvd_api_key),
        fetch_github_advisory(cve_id, config.github_token),
        fetch_epss(cve_id),
        check_cisa_kev(cve_id),
        search_osint(cve_id, config.tavily_api_key),
    )

    # Assess risk
    risk = assess_risk(nvd, epss, in_kev, osint)

    return CVEResearchResult(
        cve_id=cve_id,
        nvd=nvd,
        github=github,
        epss=epss,
        in_kev=in_kev,
        osint=osint,
        risk_assessment=risk,
    )


def assess_risk(nvd, epss, in_kev, osint) -> str:
    """Determine overall risk based on all factors."""

    if in_kev:
        return "CRITICAL - Actively Exploited (CISA KEV)"

    if epss and epss.epss >= 0.7:
        return "CRITICAL - High Exploitation Probability"

    if nvd and nvd.cvss_v3_score and nvd.cvss_v3_score >= 9.0:
        return "CRITICAL - CVSS 9.0+"

    if osint and any("exploit" in r.title.lower() for r in osint):
        return "HIGH - Exploit Available"

    if nvd and nvd.cvss_v3_score and nvd.cvss_v3_score >= 7.0:
        return "HIGH - CVSS 7.0+"

    return "MEDIUM - Monitor"
```
